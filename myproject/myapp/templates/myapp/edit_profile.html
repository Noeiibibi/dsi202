{% extends 'myapp/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}แก้ไขโปรไฟล์ของคุณ - Chum-Chon Link{% endblock %}

{% block extra_head %}
<style>
    html, body { height: 100%; }
    body { display: flex; flex-direction: column; }
    main.flex-grow { flex: 1 0 auto; }

    .edit-profile-page-bg {
        background: linear-gradient(120deg, #f3e7e9 0%, #e6e6fa 50%, #e0ffff 100%); /* Light Pink to Lavender to Light Cyan */
    }
    .dark .edit-profile-page-bg {
        background: linear-gradient(120deg, #2c1a2b 0%, #2a2a3e 50%, #1e293b 100%); /* Darker, desaturated versions */
    }

    .edit-profile-card {
        background-color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.35);
        max-width: 650px; /* Adjust max-width as needed */
    }
    .dark .edit-profile-card {
        background-color: rgba(42, 39, 61, 0.85); /* Dark Purple/Slate transparent */
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(100, 116, 139, 0.4); /* slate-500 transparent */
    }

    /* Profile Image Upload Area */
    .profile-image-upload-area {
        width: 160px; /* Increased size */
        height: 160px;
        border-radius: 50%;
        border: 3px dashed #fbcfe8; /* Pink-200 dashed border */
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden; /* To contain the image */
        cursor: pointer;
    }
    .dark .profile-image-upload-area {
        border-color: #ec4899; /* Pink-500 for dark */
    }
    .profile-image-upload-area:hover {
        border-color: #ec4899; /* Pink-500 */
        background-color: rgba(252, 231, 243, 0.2); /* pink-100 with opacity */
    }
    .dark .profile-image-upload-area:hover {
        border-color: #fce7f3; /* Pink-100 for dark hover */
        background-color: rgba(131, 24, 67, 0.1); /* pink-900 with opacity */
    }
    .profile-image-upload-area img.current-profile-img,
    .profile-image-upload-area img#imagePreview {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }
    .profile-image-upload-area .upload-icon-overlay {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        border-radius: 50%;
    }
    .profile-image-upload-area:hover .upload-icon-overlay {
        opacity: 1;
    }
    .profile-image-upload-area .upload-icon-overlay svg {
        color: white;
        width: 2.5rem; /* w-10 */
        height: 2.5rem; /* h-10 */
    }
     .profile-image-upload-area .upload-icon-overlay p {
        color: white;
        font-size: 0.75rem; /* text-xs */
        margin-top: 0.25rem;
    }
    #id_profile_image { /* Hide the default file input */
        display: none;
    }

    /* Bio Textarea Styling */
    .bio-textarea {
        min-height: 120px;
        border-color: #fbcfe8; /* Pink-200 default border */
        background-color: rgba(255,255,255,0.5); /* Slightly transparent */
        transition: all 0.2s ease-in-out;
    }
    .dark .bio-textarea {
        border-color: #4b5563; /* Gray-600 */
        background-color: rgba(55, 65, 81, 0.5); /* gray-700 transparent */
        color: #e5e7eb; /* gray-200 */
    }
    .bio-textarea:focus {
        border-color: #ec4899; /* Pink-500 focus border */
        box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2);
        background-color: white;
        outline: none;
    }
    .dark .bio-textarea:focus {
        border-color: #f472b6; /* Pink-400 focus border dark */
        box-shadow: 0 0 0 3px rgba(244, 114, 182, 0.3);
        background-color: #1f2937; /* slate-800 */
    }

    .form-field-group label {
        font-family: 'Mitr', sans-serif;
        color: #be185d; /* Pink-700 */
    }
    .dark .form-field-group label {
        color: #fbcfe8; /* Pink-200 */
    }

    .animate-popIn {
        animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.320, 1.275) forwards;
        opacity: 0;
        transform: scale(0.9);
    }
    @keyframes popIn {
        to { opacity: 1; transform: scale(1); }
    }

</style>
{% endblock %}

{% block content %}
<section class="relative min-h-screen flex items-center justify-center py-12 px-4 edit-profile-page-bg overflow-y-auto">
    <div class="w-full max-w-xl mx-auto my-8 animate-popIn">
        <form method="post" enctype="multipart/form-data" class="edit-profile-card rounded-2xl shadow-2xl p-6 sm:p-8 md:p-10 space-y-6">
            {% csrf_token %}
            <div class="text-center mb-6">
                <h1 class="text-3xl sm:text-4xl font-bold text-pink-600 dark:text-pink-400" style="font-family: 'Mitr', sans-serif;">
                    แก้ไขโปรไฟล์
                </h1>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1.5">อัปเดตข้อมูลส่วนตัวของคุณให้น่าสนใจยิ่งขึ้น!</p>
            </div>

            {% if form.non_field_errors %}
            <div class="bg-red-100 dark:bg-red-800/30 border-l-4 border-red-500 dark:border-red-400 text-red-700 dark:text-red-200 p-4 rounded-md shadow-sm" role="alert">
                <div class="flex items-start">
                    <div class="flex-shrink-0 pt-0.5">
                        <svg class="h-5 w-5 text-red-500 dark:text-red-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-.707-4.293a1 1 0 001.414-1.414L10 10.586l.707-.707a1 1 0 00-1.414-1.414L10 8.172l-.707.707a1 1 0 001.414 1.414L10 10.586l-.707.707zM10 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-semibold text-red-800 dark:text-red-100">เกิดข้อผิดพลาด:</h3>
                        <div class="mt-1 text-sm text-red-700 dark:text-red-200">
                            <ul class="list-disc list-inside space-y-0.5">
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="form-field-group space-y-2">
                <label for="profileImageUpload" class="block text-md font-semibold mb-2 text-center">รูปโปรไฟล์ของคุณ</label>
                <div id="profileImageUploadTrigger" class="profile-image-upload-area mx-auto" title="คลิกเพื่อเปลี่ยนรูปโปรไฟล์">
                    <img src="{% if form.instance.profile_image and form.instance.profile_image.url %}{{ form.instance.profile_image.url }}{% else %}{% static 'images/fw.png' %}{% endif %}"  {# <<--- CHANGED HERE #}
                         alt="รูปโปรไฟล์ปัจจุบัน"
                         class="current-profile-img"
                         id="imagePreview"
                         onerror="this.onerror=null; this.src= "{% static 'images/fw.png' %}";> 
                    <div class="upload-icon-overlay">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg>
                        <p>เปลี่ยนรูป</p>
                    </div>
                </div>
                {{ form.profile_image }} {# This will be hidden by CSS #}
                {% if form.profile_image.errors %}
                <p class="text-xs text-red-600 dark:text-red-400 font-medium text-center mt-1">{{ form.profile_image.errors.0 }}</p>
                {% endif %}
                 <p class="text-xs text-slate-500 dark:text-slate-400 text-center mt-1">คลิกที่รูปเพื่ออัปโหลดไฟล์ใหม่ (แนะนำขนาดจัตุรัส)</p>
            </div>

            <div class="form-field-group space-y-1">
                <label for="{{ form.bio.id_for_label }}" class="block text-md font-semibold">เกี่ยวกับตัวคุณ (Bio)</label>
                {% render_field form.bio class="w-full px-4 py-3 text-sm text-slate-800 dark:text-slate-100 rounded-lg border bio-textarea focus:ring-0" placeholder="เล่าเรื่องราวของคุณให้เพื่อนๆ รู้จัก..." rows="5" %}
                {% if form.bio.errors %}
                <p class="text-xs text-red-600 dark:text-red-400 font-medium mt-1">{{ form.bio.errors.0 }}</p>
                {% endif %}
                <p class="text-xs text-slate-400 dark:text-slate-500">ไม่เกิน 250 ตัวอักษร</p>
            </div>

            <div class="pt-4 flex justify-end">
                <button type="submit" class="action-button-primary px-6 py-2.5 rounded-xl text-sm font-semibold transition-colors shadow-md hover:shadow-lg transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a1 1 0 011 1v3a1 1 0 11-2 0V8h-4v3.586l-1.293-1.293zM4 4a1 1 0 011-1h10a1 1 0 011 1v1H4V4z" /></svg>
                    บันทึกการเปลี่ยนแปลง
                </button>
            </div>
        </form>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const profileImageUploadTrigger = document.getElementById('profileImageUploadTrigger');
    const profileImageInput = document.getElementById('id_profile_image');
    const imagePreview = document.getElementById('imagePreview');
    const originalImageSrc = imagePreview ? imagePreview.src : "{% static 'images/fw.png' %}"; // <<--- CHANGED HERE

    if (profileImageUploadTrigger && profileImageInput && imagePreview) {
        profileImageUploadTrigger.addEventListener('click', function() {
            profileImageInput.click();
        });

        profileImageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                }
                reader.readAsDataURL(file);
            } else {
                imagePreview.src = originalImageSrc;
            }
        });
    }
});
</script>
{% endblock %}